name: CD with Docker

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          # submodules 제거됨
          token: ${{ secrets.ACTIONS_TOKEN }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          driver-opts: |
            network=host

      - name: Login to Github Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.ACTIONS_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=sha

      - name: Build and Push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: [ self-hosted ]

    steps:
      # rootless nerdctl 안정화 (runner 서비스 환경에서 XDG_RUNTIME_DIR 누락 대비)
      - name: Prepare rootless nerdctl env
        shell: bash
        run: |
          echo "/usr/local/bin" >> "$GITHUB_PATH"
          echo "XDG_RUNTIME_DIR=/run/user/$(id -u)" >> "$GITHUB_ENV"
          # 환경에 따라 필요할 수 있음(기본은 불필요한 게 정상)
          # echo "CONTAINERD_ADDRESS=/run/user/$(id -u)/containerd-rootless/containerd.sock" >> "$GITHUB_ENV"

      # 서버의 private config repo를 갱신 (이미 클론돼 있으면 pull / 없으면 clone)
      - name: Update private config repo
        shell: bash
        env:
          CONFIG_DIR: ${{ vars.CONFIG_DIR }}              # 예: /home/queuing/config-repo
          CONFIG_REPO_URL: ${{ secrets.CONFIG_REPO_URL }} # 예: https://github.com/org/private-config.git
          CONFIG_REPO_PAT: ${{ secrets.CONFIG_REPO_PAT }} # repo read 권한 PAT (또는 deploy key로 대체)
          CONFIG_REF: ${{ vars.CONFIG_REF }}              # 예: main
        run: |
          set -euo pipefail
          if [ ! -d "$CONFIG_DIR/.git" ]; then
            rm -rf "$CONFIG_DIR"
            git clone "https://x-access-token:${CONFIG_REPO_PAT}@${CONFIG_REPO_URL#https://}" "$CONFIG_DIR"
          fi
          git -C "$CONFIG_DIR" fetch --prune origin
          git -C "$CONFIG_DIR" reset --hard "origin/${CONFIG_REF:-main}"

      # GHCR 로그인 (rootless라 sudo 제거)
      - name: Login to GHCR
        run: echo "${{ secrets.ACTIONS_TOKEN }}" | nerdctl login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Pull latest image
        run: nerdctl pull ${{ needs.build.outputs.image-tag }}

      # 네트워크 없으면 생성(처음 한번)
      - name: Ensure network exists
        shell: bash
        run: |
          nerdctl network inspect "${{ vars.NETWORK_NAME }}" >/dev/null 2>&1 \
            || nerdctl network create "${{ vars.NETWORK_NAME }}"

      - name: Clean up old container and image
        shell: bash
        run: |
          nerdctl rm -f "${{ vars.CONTAINER_NAME }}" || true
          nerdctl images "ghcr.io/${{ github.repository }}" \
            --format "{{.Repository}}:{{.Tag}}" \
            | grep -v "${{ needs.build.outputs.image-tag }}" \
            | xargs -r nerdctl rmi -f || true

      - name: Run New Container (mount /config read-only)
        shell: bash
        env:
          CONFIG_DIR: ${{ vars.CONFIG_DIR }}         # 예: /home/queuing/config-repo
          CONFIG_PROFILE_DIR: ${{ vars.CONFIG_PROFILE_DIR }} # 예: dev (CONFIG_DIR/dev 를 /config로 마운트)
        run: |
          nerdctl run -d \
            --name "${{ vars.CONTAINER_NAME }}" \
            --network "${{ vars.NETWORK_NAME }}" \
            -p "127.0.0.1:${{ secrets.DEV_WEB_PORT }}:8080" \
            -v "${CONFIG_DIR}/${CONFIG_PROFILE_DIR}:/config:ro" \
            -e SPRING_PROFILES_ACTIVE=dev \
            -e TZ=Asia/Seoul \
            ${{ needs.build.outputs.image-tag }}
